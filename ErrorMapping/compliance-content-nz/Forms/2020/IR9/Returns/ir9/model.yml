---
name: IR9 Clubs and societies return
model:
  fields:
    <<: !include
      source: ../../../Common/taxcalculatormodel.yml
      path: taxCalculatorFields
    
    <<: !include
      source: ../../../Common/provCalculatorModel.yml
      path: provCalculatorFields
 
    taxYear:
      type: number
      decimals: 0
      defaultValue:  "2020"
    irdNumber:
      type: number
      decimals: 0
      mandatory: true
    nonResidentIndicator:
      defaultValue: false
      type: boolean
    isNilReturn:
      defaultValue: false
      type: boolean
    isFinalReturn:
      defaultValue: false
      type: boolean
    isAmended:
      defaultValue: false
      type: boolean
    amendReason:
      mandatory: = isAmended <> FALSE
      options:
        - label: Calculation error
          value: MATH
        - label: Incorrect amount entered
          value: KEY
        - label: Transposition error
          value: TRNSPO
        - label: Other
          value: OTHER
      type: select
    amendDetails:
      mandatory: = isAmended <> FALSE
      type: text
    submissionKey:
      maxLength: 32
      type: text
    incorporatedBody:
      type: boolean
      value:  =IF(entityType = "I",FALSE,TRUE)
    entityType:
      options:
        - label: Unincorporated
          value: I
        - label: Incorporated
          value: C
      type: select
      defaultValue: I
    typeOfClubOrSociety:
      type: select
      options:
        - label: Friendly society
          value: F
        - label: Amateur sports club, charitable society, etc
          value: X
        - label: All other clubs or societies
          value: A
      defaultValue:  X
    residentialRentalIncome_Indicator:
      type: select
      options:
        - label: Portfolio
          value: P
        - label: Individual
          value: I
        - label: Combined
          value: C
    residentialRentalIncome_totalIncome:
      type: number
      decimals: 2
    residentialRentalIncome_excessDeductionsBroughtForward:
      type: number
      decimals: 2
    residentialRentalIncome_residentialRentalDeductions:
      type: number
      decimals: 2
    residentialRentalIncome_deductionsClaimedThisYear:
      type: number
      decimals: 2
    residentialRentalIncome_excessDeductionsCarriedForward:
      type: number
      decimals: 2
      value: =IF(residentialRentalIncome_excessDeductionsBroughtForward + residentialRentalIncome_residentialRentalDeductions - residentialRentalIncome_deductionsClaimedThisYear > 0,
              residentialRentalIncome_excessDeductionsBroughtForward + residentialRentalIncome_residentialRentalDeductions - residentialRentalIncome_deductionsClaimedThisYear,NULL)
    residentialRentalIncome_netIncome:
      type: number
      decimals: 2
      value: =IF(residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear = 0,
              NULL,residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear)       
    saleOfProperty:
      decimals: 2
      type: number
    uifriendlyNetIncome:
      decimals: 2
      type: number     
    friendlyNetIncome:
      decimals: 2
      type: number
      value: =IF(AND(typeOfClubOrSociety <> "X",typeOfClubOrSociety <> "A"),uifriendlyNetIncome,NULL)
    interestIncome_totalTaxPaid:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXinterestIncome_totalTaxPaid, uiinterestIncome_totalTaxPaid))
    interestIncome_totalIncome:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXinterestIncome_totalIncome, uiinterestIncome_totalIncome))
    dividendIncome_totalImputationCredits:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXdividendIncome_totalImputationCredits, uidividendIncome_totalImputationCredits))
    dividendIncome_totalRWTCredits:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXdividendIncome_totalRWTCredits, uidividendIncome_totalRWTCredits))
    dividendIncome_totalGrossDividends:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXdividendIncome_totalGrossDividends, uidividendIncome_totalGrossDividends))
    maoriAuthorityDistributions_totalMACredits:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXmaoriAuthorityDistributions_totalMACredits, uimaoriAuthorityDistributions_totalMACredits))
    maoriAuthorityDistributions_totalMADistributions:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXmaoriAuthorityDistributions_totalMADistributions, uimaoriAuthorityDistributions_totalMADistributions))
    overseasIncome_totalTaxPaid:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXoverseasIncome_totalTaxPaid, uioverseasIncome_totalTaxPaid))
    overseasIncome_totalIncome:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXoverseasIncome_totalIncome, uioverseasIncome_totalIncome))
    taxableMADistributions:
      decimals: 2
      type: number
    otherIncome:
      decimals: 2
      type: number
      value: =IF(typeOfClubOrSociety = "F", NULL,IF(typeOfClubOrSociety = "X",uiXotherIncome, uiotherIncome))
    incomeBeforeDeduction:
      decimals: 2
      type: number
      value: =IF(AND(typeOfClubOrSociety <> "X",typeOfClubOrSociety <> "F"),calcincomeBeforeDeduction,NULL)
    incomeTaxDeductionForNonProfit:
      decimals: 2
      type: number
      value: =IF(AND(typeOfClubOrSociety <> "X",typeOfClubOrSociety <> "F"),calcincomeTaxDeductionForNonProfit,NULL)
    totalIncome:
      decimals: 2
      type: number
      value: =IF(AND(typeOfClubOrSociety <> "X",typeOfClubOrSociety <> "F"),calctotalIncome,NULL)
    # START OF A TYPE SOCIETY
    uiinterestIncome_totalTaxPaid:
      decimals: 2
      type: number
    uiinterestIncome_totalIncome:
      decimals: 2
      type: number
    uidividendIncome_totalImputationCredits:
      decimals: 2
      type: number
    uidividendIncome_totalRWTCredits:
      decimals: 2
      type: number
    uidividendIncome_totalGrossDividends:
      decimals: 2
      type: number
    uimaoriAuthorityDistributions_totalMACredits:
      decimals: 2
      type: number
    uimaoriAuthorityDistributions_totalMADistributions:
      decimals: 2
      type: number
    uioverseasIncome_totalTaxPaid:
      decimals: 2
      type: number
    uioverseasIncome_totalIncome:
      decimals: 2
      type: number
    uiotherIncome:
      decimals: 2
      type: number
    calcincomeBeforeDeduction:
      decimals: 2
      type: number
      value: =interestIncome_totalIncome + dividendIncome_totalGrossDividends + maoriAuthorityDistributions_totalMADistributions + overseasIncome_totalIncome + otherIncome
    calcincomeTaxDeductionForNonProfit:
      decimals: 2
      type: number
      value: =IF(incomeBeforeDeduction > 1000,1000, incomeBeforeDeduction)
    calctotalIncome:
      decimals: 2
      type: number
      value: =incomeBeforeDeduction - incomeTaxDeductionForNonProfit
    # END OF A TYPE SOCIETY

    # START OF X TYPE SOCIETY
    uiXinterestIncome_totalTaxPaid:
      decimals: 2
      type: number
      # value: =IF(typeOfClubOrSociety <> "X",2,1)
    uiXinterestIncome_totalIncome:
      decimals: 2
      type: number
    uiXdividendIncome_totalImputationCredits:
      decimals: 2
      type: number
    uiXdividendIncome_totalRWTCredits:
      decimals: 2
      type: number
    uiXdividendIncome_totalGrossDividends:
      decimals: 2
      type: number
    uiXmaoriAuthorityDistributions_totalMACredits:
      decimals: 2
      type: number
    uiXmaoriAuthorityDistributions_totalMADistributions:
      decimals: 2
      type: number
    uiXoverseasIncome_totalTaxPaid:
      decimals: 2
      type: number
    uiXoverseasIncome_totalIncome:
      decimals: 2
      type: number
    uiXtaxableMADistributions:
      decimals: 2
      type: number
    uiXotherIncome:
      decimals: 2
      type: number
    # END OF X TYPE SOCIETY
    donationsMade:
      decimals: 2
      type: number
    netIncome:
      decimals: 2
      type: number
      value: =netIncomeBeforeDonations - donationsMade
    netIncomeBeforeDonations:
      decimals: 2
      type: number
      value: =residentialRentalIncome_netIncome + saleOfProperty +friendlyNetIncome +  interestIncome_totalIncome + dividendIncome_totalGrossDividends + maoriAuthorityDistributions_totalMADistributions + overseasIncome_totalIncome + otherIncome 
    lossesBroughtForward:
      decimals: 2
      type: number
    lossesClaimedThisYear:
      decimals: 2
      type: number
    totalTaxableIncome:
      decimals: 2
      type: number
      value:  =netIncome - lossesClaimedThisYear
    # taxOnTaxableIncome:
    #   decimals: 2
    #   type: number
    #   value:  =ROUND(IF(totalTaxableIncome > 70000,((totalTaxableIncome - 70000) * 0.33) + ((70000 - 48000) * 0.3) + ((48000 - 14000) * 0.175) + (14000 * 0.105),
    #           IF(totalTaxableIncome > 48000,((totalTaxableIncome - 48000) * 0.3) + ((48000 - 14000) * 0.175) + (14000 * 0.105),IF(totalTaxableIncome > 14000,
    #           ((totalTaxableIncome - 14000) * 0.175) + (14000 * 0.105),totalTaxableIncome * 0.105))),2)
    overseasIncometotalTaxPaid:
      decimals: 2
      type: number
    taxAfterOverseasTax:
      decimals: 2
      type: number
      #value: taxOnTaxableIncome - overseasIncometotalTaxPaid
      value: =IF(taxOnTaxableIncome >= overseasIncometotalTaxPaid , taxOnTaxableIncome - overseasIncometotalTaxPaid , 0)
    taxAfterImpCredits:
      type: number
      decimals: 2
      value: =IF(taxAfterOverseasTax >= (imputationCreditsReceived + imputationBroughtForward),taxAfterOverseasTax-(imputationCreditsReceived + imputationBroughtForward),0)
      # 5 + 5
      # value:  =IF(taxAfterOverseasTax >=dividendImputationCredits , taxAfterOverseasTax - dividendImputationCredits ,0)
    taxAfterRDCredits:
      type: number
      decimals: 2
      #value: taxAfterImpCredits - researchAndDevelopment_nonrefundableCredit
      value:  =IF(taxAfterImpCredits >= researchAndDevelopment_nonrefundableCredit , 
                taxAfterImpCredits - researchAndDevelopment_nonrefundableCredit ,0)
    imputationCreditsReceived:
      decimals: 2
      type: number
    imputationBroughtForward:
      decimals: 2
      type: number
    researchAndDevelopment_nonrefundableCredit:
      type: number
      decimals: 2
    researchAndDevelopment_refundableCredit:
      type: number
      decimals: 2
    taxCreditsForTM:
      type: number
      decimals: 2
      defaultValue: "0"
    useOfMoneyInterest:
      type: number
      defaultValue: "0"
      decimals: 2
    uomiStartDate:
      type: date
      defaultValue: 31/03/2020
    totalRWTDeducted:
      decimals: 2
      type: number
    rlwtCredit:
      decimals: 2
      type: number
    otherTaxCredits:
      decimals: 2
      type: number
      #value:  taxAfterRDCredits - totalRWTDeducted - rlwtCredit
      # subtotal - rew withhold - rwt no limit
    residualIncomeTax:
      decimals: 2
      type: number
      value: =taxAfterRDCredits - totalRWTDeducted - rlwtCredit - otherTaxCredits
    provisionalTaxPaid:
      decimals: 2
      type: number
    penaltiesDue:
      decimals: 2
      type:  number
    transfersFromOtherReturns:
      decimals: 2
      type: number
    terminalTax:
      decimals: 2
      type: number
      value:  =residualIncomeTax - provisionalTaxPaid + penaltiesDue - transfersFromOtherReturns
    overpaymentProvisionalTax:
      decimals: 2
      type: number
    provTaxEvenSplit:
      defaultValue: false
      type: boolean
    provisionalTax_provisionalTaxStartDate:
      type: date
    provisionalTax_provisionalTaxOption:
      mandatory: true
      options:
        - label: Standard
          value: STD
        - label: Estimated
          value: EST
        - label: Ratio
          value: RATIO
      type: select
    provisionalTaxCalc:
      type: number
      decimals: 2
      value:  = IF(residualIncomeTax > 2500 , IF(provisionalTax_provisionalTaxOption = "STD" , residualIncomeTax * 1.05 , 0 ) , 0 )
    provFromTaxManager:
      type: number
      decimals: 2
    # provisionalTax_provisionalTaxPayable:
    #   decimals: 2
    #   type: number
    #   value:  = IF(provisionalTax_provisionalTaxOption = "STD" , provisionalTaxCalc , provFromTaxManager )
# Transfer section
    totalRefundDue:
      decimals: 2
      type: number
      value:  =terminalTax + overpaymentProvisionalTax
    transferRefundTo:
      type: list
      maxRows:  10
      fields:
        transferIrdNumber:
          type: number
          decimals: 0     
        transferAccountType:
          options:
            - label: Income tax
              value: INC
            - label: Approved issuer levy
              value: AIL
            - label: Account information provider
              value: AIP
            - label: Common reporting standard
              value: CRS
            - label: Dividend withholding tax
              value: DWT
            - label: Fringe benefit tax
              value: FBT
            - label: Gaming machine duty
              value: GMD
            - label: GST on goods sold in satisfaction of debt
              value: GSD
            - label: Goods and services tax
              value: GST
            - label: Resident withholding tax on interest
              value: IPS
            - label: Resident withholding tax on interest (exempt recipient)
              value: IPE
            - label: Non-resident withholding tax
              value: NRT
            - label: Portfolio investment entity tax
              value: PIE
            - label: Payroll subsidy account
              value: PRS
            - label: 'Tax credits - donations, childcare, housekeeper'
              value: REB
            - label: Resident land withholding tax
              value: RLT
            - label: Resident withholding tax on specified dividends
              value: RWT
            - label: Student loan
              value: SLS
            - label: Working for families tax credits
              value: FAM
          type: select
        transferAmount:
          decimals: 2
          type: number
        associatedCustomer:
          defaultValue: false
          type: boolean
        transferFilingPeriod:
          defaultValue: 31/03/2020
          type: date
    transferTotal:
      decimals: 2
      type: number
      value:  =SUM(transferRefundTo:transferAmount)    
    transferRemaining:
      decimals: 2
      type: number
      value:  =totalRefundDue + transferTotal