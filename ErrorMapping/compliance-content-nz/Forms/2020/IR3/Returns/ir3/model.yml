---
name: IR3 Individual return
model:
  fields:
    <<: !include
      source: ../../../Common/taxcalculatormodel.yml
      path: taxCalculatorFields

    <<: !include
      source: ../../../Common/provCalculatorModel.yml
      path: provCalculatorFields

    entityType:
      type: text
      defaultValue:  I
    taxYear:
      type: number
      decimals: 0
      defaultValue:  "2020"
    irdNumber:
      type: text
      mandatory: true
    nonResidentIndicator:
      defaultValue: false
      type: boolean
    isNilReturn:
      defaultValue: false
      type: boolean
    isFinalReturn:
      defaultValue: false
      type: boolean
    isAmended:
      defaultValue: false
      type: boolean
    amendReason:
      mandatory: = isAmended <> FALSE
      options:
        - label: Calculation error
          value: MATH
        - label: Incorrect amount entered
          value: KEY
        - label: Transposition error
          value: TRNSPO
        - label: Other
          value: OTHER
      type: select
    amendDetails:
      mandatory: = isAmended <> FALSE
      type: text
    submissionKey:
      maxLength: 32
      type: text
    ir215Attached:
      defaultValue: false
      type: boolean
    totalFTCFromWINZ:
      type: number
      decimals: 2
    totalPAYEDeducted:
      type: number
      decimals: 2
    totalGrossIncome:
      type: number
      decimals: 2
    totalIncomeNotLiableForACCLevy:
      type: number
      decimals: 2
    accEarnersLevy:
      type: number
      decimals: 2
      value:  =IF(AND(totalGrossIncome > 0 , totalGrossIncome <> NULL),
              IF((totalGrossIncome - totalIncomeNotLiableForACCLevy) * 0.0139 <= 1785.73,(totalGrossIncome - totalIncomeNotLiableForACCLevy) * 0.0139,1785.73),
              NULL)
    totalTCPDs:
      type: number
      decimals: 2
    totalExtinguishedTCPDs:
      type: number
      decimals: 2
    totalTaxDeducted:
      type: number
      decimals: 2
      value:  =IF(totalPAYEDeducted - accEarnersLevy > 0, totalPAYEDeducted - accEarnersLevy, NULL)
    grossSchedularPayments:
      decimals: 2
      type: number
    taxDeductedFromSchedularPayments:
      decimals: 2
      type: number
    schedularExpenses:
      decimals: 2
      type: number
    netSchedularPayments:
      decimals: 2
      type: number
      value:  =IF(grossSchedularPayments - schedularExpenses> 0,grossSchedularPayments - schedularExpenses, NULL)
    rlwtCredit:
      decimals: 2
      type: number
    interestIncome_totalTaxPaid:
      decimals: 2
      type: number
    interestIncome_totalIncome:
      decimals: 2
      type: number
    interestFromPShipEstTrustOrLTC:
      type: boolean
      defaultValue: false
    pieIncome_totalTaxCredits:
      decimals: 2
      type: number
    pieIncome_totalIncome:
      decimals: 2
      type: number
    dividendIncome_totalImputationCredits:
      decimals: 2
      type: number
    dividendIncome_totalRWTCredits:
      decimals: 2
      type: number
    dividendIncome_totalGrossDividends:
      decimals: 2
      type: number
    dividendsFromPShipEstTrustOrLTC:
      type: boolean
      defaultValue: false
    maoriAuthorityDistributions_totalMACredits:
      decimals: 2
      type: number
    maoriAuthorityDistributions_totalMADistributions:
      decimals: 2
      type: number
    totalTaxPaidByTrustees:
      decimals: 2
      type: number
    totalEstateOrTrustIncome:
      decimals: 2
      type: number
    totalTaxableDistributionFromNCTrusts:
      decimals: 2
      type: number
    overseasIncome_totalTaxPaid:
      decimals: 2
      type: number
    overseasIncome_totalIncome:
      decimals: 2
      type: number
    overseasSuperLumpSums:
      type: boolean
      defaultValue: false
    partnershipIncome_totalTaxCredits:
      type: number
      decimals: 2
    partnershipIncome_totalIncome:
      type: number
      decimals: 2
    ltcIncome_totalTaxCredits:
      decimals: 2
      type: number
    ltcIncome_totalIncome:
      decimals: 2
      type: number
    ltcNonAllowableDeductions:
      decimals: 2
      type: number
    ltcPriorYearNonAllowableDeductionsClaimed:
      decimals: 2
      type: number
    ltcAdjustedIncome:
      decimals: 2
      type: number
      value:  =IF(ltcIncome_totalIncome + ltcNonAllowableDeductions - ltcPriorYearNonAllowableDeductionsClaimed > 0,
               ltcIncome_totalIncome + ltcNonAllowableDeductions - ltcPriorYearNonAllowableDeductionsClaimed,
               NULL)
    totalShareholderEmployeeSalary:
      decimals: 2
      type: number
    futureShareholderSalary:
      type: boolean
      defaultValue: false
    shareholderAIMTaxPaid:
      type: number
      decimals: 2
    totalTaxCredits:
      decimals: 2
      type: number
      value: = totalTaxDeducted + taxDeductedFromSchedularPayments + interestIncome_totalTaxPaid + dividendIncome_totalRWTCredits +
               maoriAuthorityDistributions_totalMACredits + totalTaxPaidByTrustees + pieIncome_totalTaxCredits +
              partnershipIncome_totalTaxCredits + ltcIncome_totalTaxCredits + shareholderAIMTaxPaid + rlwtCredit
    totalIncomeSubtotal:
      decimals: 2
      type: number
      value: = totalGrossIncome + netSchedularPayments + interestIncome_totalIncome + dividendIncome_totalGrossDividends + maoriAuthorityDistributions_totalMADistributions +
              totalEstateOrTrustIncome + totalTaxableDistributionFromNCTrusts + overseasIncome_totalIncome + pieIncome_totalIncome + partnershipIncome_totalIncome +
              totalShareholderEmployeeSalary + ltcAdjustedIncome
    residentialRentalIncome_Indicator:
      type: select
      options:
        - label: Portfolio
          value: P
        - label: Individual
          value: I
        - label: Combined
          value: C
    residentialRentalIncome_totalIncome:
      type: number
      decimals: 2
    residentialRentalIncome_excessDeductionsBroughtForward:
      type: number
      decimals: 2
    residentialRentalIncome_residentialRentalDeductions:
      type: number
      decimals: 2
    residentialRentalIncome_deductionsClaimedThisYear:
      type: number
      decimals: 2
    residentialRentalIncome_excessDeductionsCarriedForward:
      type: number
      decimals: 2
      value: =IF(residentialRentalIncome_excessDeductionsBroughtForward + residentialRentalIncome_residentialRentalDeductions - residentialRentalIncome_deductionsClaimedThisYear > 0,
              residentialRentalIncome_excessDeductionsBroughtForward + residentialRentalIncome_residentialRentalDeductions - residentialRentalIncome_deductionsClaimedThisYear,NULL)
    residentialRentalIncome_netIncome:
      type: number
      decimals: 2
      value: =IF(residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear = 0,
               NULL,residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear)
      # value: =residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear
    netRentalIncome:
      decimals: 2
      type: number
    selfEmployedIncome:
      decimals: 2
      type: number
    saleOfProperty:
      type: number
      decimals: 2
    otherIncome:
      decimals: 2
      type: number
    totalIncome:
      decimals: 2
      type: number
      value:  =totalIncomeSubtotal + residentialRentalIncome_netIncome + netRentalIncome + selfEmployedIncome + saleOfProperty + otherIncome
    otherExpenses:
      decimals: 2
      type: number
    totalIncomeLossAfterExpenses:
      decimals: 2
      type: number
      value: =totalIncome - otherExpenses
    lossesBroughtForward:
      decimals: 2
      type: number
    lossesClaimedThisYear:
      decimals: 2
      type: number
    totalTaxableIncome:
      decimals: 2
      type: number
      value: = totalIncomeLossAfterExpenses - lossesClaimedThisYear - totalTaxableDistributionFromNCTrusts
    dispTotalTaxableIncome:
      decimals: 2
      type: number
      value: = totalIncomeLossAfterExpenses - lossesClaimedThisYear
    eligibleForIETC:
      type: boolean
      defaultValue: false
    exclusionDateRange:
      type: list
      fields:
        excludedOverseasIncomeStartDate:
          type: date
        excludedOverseasIncomeEndDate:
          type: date
    numberOfQualifyingMonths:
      type: number
      valid:
        - expression: '=numberOfQualifyingMonths  <= 12'
          errorMessage: Number of qualifying months can't be more than 12
      decimals: 0
    amountOfIETCClaimed:
      type: number
      decimals: 2
      value:  =IF(AND(eligibleForIETC=TRUE,totalIncomeLossAfterExpenses>=24000,totalIncomeLossAfterExpenses<=48000),
              IF(totalIncomeLossAfterExpenses > 44000,
              520 - ((48000 - totalIncomeLossAfterExpenses) * 0.13) * numberOfQualifyingMonths / 12,
              520 * numberOfQualifyingMonths / 12),
              NULL)
    imputationBroughtForward:
      type: number
      decimals: 2
    ncTrustTax:
      type: number
      decimals: 2
      value: = totalTaxableDistributionFromNCTrusts * 0.45
    # taxOnTaxableIncome:
    #   decimals: 2
    #   type: number
    #   value:  =ROUND(IF(totalTaxableIncome > 70000,((totalTaxableIncome - 70000) * 0.33) + ((70000 - 48000) * 0.3) + ((48000 - 14000) * 0.175) + (14000 * 0.105),
    #           IF(totalTaxableIncome > 48000,((totalTaxableIncome - 48000) * 0.3) + ((48000 - 14000) * 0.175) + (14000 * 0.105),IF(totalTaxableIncome > 14000,
    #           ((totalTaxableIncome - 14000) * 0.175) + (14000 * 0.105),totalTaxableIncome * 0.105))),2)
# What about tax on NC Trust distributions? Need to calc this at 45c in dollar, so needs special consideration
    totTaxOnTaxableIncome:
      type: number
      decimals: 2
      value: = taxOnTaxableIncome + ncTrustTax
    totalIETC:
      decimals: 2
      type: number
      value:  =amountOfIETCClaimed
    taxAfterIETC:
      decimals: 2
      type: number
      value:  =IF(totTaxOnTaxableIncome >= amountOfIETCClaimed , totTaxOnTaxableIncome - amountOfIETCClaimed , 0)
    overseasIncometotalTaxPaid:
      decimals: 2
      type: number
      value:  =overseasIncome_totalTaxPaid
    taxAfterOverseasTax:
      type: number
      decimals: 2
      value: =IF(taxAfterIETC >= overseasIncometotalTaxPaid , taxAfterIETC - overseasIncometotalTaxPaid , 0)
    imputationCredits:
      decimals: 2
      type: number
      value: =dividendIncome_totalImputationCredits + imputationBroughtForward
    taxAfterImpCredits:
      type: number
      decimals: 2
      value:  =IF(taxAfterOverseasTax >= imputationCredits , taxAfterOverseasTax - imputationCredits ,0)
  # If Div imp credits greater than tax available, then they should be carried forward, done in workpaper?
    researchAndDevelopment_nonrefundableCredit:
      type: number
      decimals: 2
    taxAfterRDCredits:
      type: number
      decimals: 2
      value:  =IF(taxAfterImpCredits >= researchAndDevelopment_nonrefundableCredit , taxAfterImpCredits - researchAndDevelopment_nonrefundableCredit ,0)
    totalremainingTaxCredits:
      decimals: 2
      type: number
      value:  =totalTaxDeducted + taxDeductedFromSchedularPayments + interestIncome_totalTaxPaid + dividendIncome_totalRWTCredits +
              maoriAuthorityDistributions_totalMACredits + totalTaxPaidByTrustees + pieIncome_totalTaxCredits +
              partnershipIncome_totalTaxCredits + ltcIncome_totalTaxCredits + shareholderAIMTaxPaid + rlwtCredit
    taxCreditsForTM:
      type: number
      decimals: 2
      defaultValue: "0"
    residualIncomeTax:
      decimals: 2
      type: number
      value:  =taxAfterRDCredits - totalremainingTaxCredits
    totIncomeNetLoss:
      decimals: 2
      type: number
    provisionalTaxPaid:
      decimals: 2
      type: number
    penaltiesDue:
      decimals: 2
      type:  number
    transfersFromOtherReturns:
      decimals: 2
      type: number
    terminalTax:
      decimals: 2
      type: number
      value:  =residualIncomeTax - provisionalTaxPaid + penaltiesDue - transfersFromOtherReturns
    earlyPaymentDiscountEligibility:
      type: boolean
      defaultValue: false
    earlyPaymentDiscount:
      type:  number
      decimals: 2
      defaultValue: "0"
    useOfMoneyInterest:
      type: number
      decimals: 2
      defaultValue: "0"
    uomiStartDate:
      type: date
      defaultValue: 31/03/2020
# Transfer section
    overpaymentProvisionalTax:
      decimals: 2
      type: number
    totalRefundDue:
      decimals: 2
      type: number
      value:  =terminalTax + overpaymentProvisionalTax
    transferRefundTo:
      type: list
      maxRows:  10
      fields:
        transferIrdNumber:
          type: number
          decimals: 0
        transferAccountType:
          options:
            - label: Income tax
              value: INC
            - label: Approved issuer levy
              value: AIL
            - label: Account information provider
              value: AIP
            - label: Common reporting standard
              value: CRS
            - label: Dividend withholding tax
              value: DWT
            - label: Fringe benefit tax
              value: FBT
            - label: Gaming machine duty
              value: GMD
            - label: GST on goods sold in satisfaction of debt
              value: GSD
            - label: Goods and services tax
              value: GST
            - label: Resident withholding tax on interest
              value: IPS
            - label: Resident withholding tax on interest (exempt recipient)
              value: IPE
            - label: Non-resident withholding tax
              value: NRT
            - label: Portfolio investment entity tax
              value: PIE
            - label: Payroll subsidy account
              value: PRS
            - label: 'Tax credits - donations, childcare, housekeeper'
              value: REB
            - label: Resident land withholding tax
              value: RLT
            - label: Resident withholding tax on specified dividends
              value: RWT
            - label: Student loan
              value: SLS
            - label: Working for families tax credits
              value: FAM
          type: select
        transferAmount:
          decimals: 2
          type: number
        associatedCustomer:
          defaultValue: false
          type: boolean
        transferFilingPeriod:
          defaultValue: 31/03/2020
          type: date
    transferTotal:
      decimals: 2
      type: number
      value:  =SUM(transferRefundTo:transferAmount)
    transferRemaining:
      decimals: 2
      type: number
      value:  =totalRefundDue + transferTotal
    provisionalTax_provisionalTaxOption:
      mandatory: true
      options:
        - label: Standard
          value: STD
        - label: Estimated
          value: EST
        - label: Ratio
          value: RATIO
      type: select
    provTaxEvenSplit:
      defaultValue: false
      type: boolean
    provisionalTax_provisionalTaxStartDate:
      type: date
    provisionalTaxCalc:
      type: number
      decimals: 2
      value:  =IF(residualIncomeTax > 2500 , IF(provisionalTax_provisionalTaxOption = "STD" , residualIncomeTax * 1.05 , 0 ) , 0 )
    provFromTaxManager:
      type: number
      decimals: 2
    # provisionalTax_provisionalTaxPayable:
    #   decimals: 2
    #   type: number
    #   value:  = IF(provisionalTax_provisionalTaxOption = "STD" , provisionalTaxCalc , provFromTaxManager )
    withholdingTaxDeducted:
      type: boolean
      defaultValue: false
    foreignInterestDisclosure:
      type: boolean
      defaultValue: false
    partYearReturnIndicator:
      type: boolean
      defaultValue: false
    partYearReason:
      type: select
      mandatory:  =partYearReturnIndicator = TRUE
      options:
        - label:  Arrived in New Zealand and now a tax resident
          value:  ARRIVE
        - label:  Declared bankrupt
          value:  BRUPT
        - label:  Balance date changed during the year
          value:  BDATE
        - label:  Returns is for a deceased person to the date of death
          value:  DECD
        - label:  Left New Zealand permanently (for more than 325 days)
          value:  DEPART
        - label:  Student loan borrower and left New Zealand for 184 days or more
          value:  STUDLN
    partYearStartDate:
      type: date
    partYearEndDate:
      type: date