---
name: IR3NR Non-resident individual return
model:
  fields:
    <<: !include
      source: ../../../Common/taxcalculatormodel.yml
      path: taxCalculatorFields

    <<: !include
      source: ../../../Common/provCalculatorModel.yml
      path: provCalculatorFields

    entityType:
      type: text
      defaultValue:  I
    taxYear:
      type: number
      decimals: 0
      defaultValue:  "2020"
    irdNumber:
      type: text
      mandatory: true
    isNilReturn:
      defaultValue: false
      type: boolean
    isFinalReturn:
      defaultValue: false
      type: boolean
    isAmended:
      defaultValue: false
      type: boolean
    amendReason:
      mandatory: = isAmended <> FALSE
      options:
        - label: Calculation error
          value: MATH
        - label: Incorrect amount entered
          value: KEY
        - label: Transposition error
          value: TRNSPO
        - label: Other
          value: OTHER
      type: select
    amendDetails:
      mandatory: = isAmended <> FALSE
      type: text
    submissionKey:
      maxLength: 32
      type: text
    nzSuperIndicator:
      defaultValue: false
      type: boolean
    totalInterestRWT:
      decimals: 2
      type: number
    totalInterest:
      decimals: 2
      type: number
    nrwtOnTotalInterest:
      type: number
      decimals: 2
    totalDividendCredits:
      decimals: 2
      type: number
    totalDividends:
      decimals: 2
      type: number
    nrwtOnTotalDividends:
      type: number
      decimals: 2
    totalWithholdingTaxOnRoyalties:
      decimals: 2
      type: number
    totalRoyalties:
      decimals: 2
      type: number
    nrwtOnTotalRoyalties:
      type: number
      decimals: 2
    totalTaxCredits:
      decimals: 2
      type: number
      value: =totalInterestRWT + totalDividendCredits + totalWithholdingTaxOnRoyalties
    totalNRWTTax:
      type: number
      decimals: 2
      value: =nrwtOnTotalInterest + nrwtOnTotalDividends + nrwtOnTotalRoyalties
    totalFTCFromWINZ:
      type: number
      decimals: 2
    totalPAYEDeducted:
      type: number
      decimals: 2
    # totalTaxDeducted:
    #   type: number
    #   decimals: 2
#      value:  =IF(totalPAYEDeducted - accEarnersLevy > 0, totalPAYEDeducted - accEarnersLevy, NULL)
    totalGrossIncome:
      type: number
      decimals: 2
    # totalIncomeNotLiableForACCLevy:
    #   type: number
    #   decimals: 2
    # accEarnersLevy:
    #   type: number
    #   decimals: 2
    #   value:  =IF(AND(totalGrossIncome > 0 , totalGrossIncome <> NULL),
    #           IF((totalGrossIncome - totalIncomeNotLiableForACCLevy) * 0.0139 <= 1755.37,(totalGrossIncome - totalIncomeNotLiableForACCLevy) * 0.0139,1755.37),
    #           NULL)
    # totalTCPDs:
    #   type: number
    #   decimals: 2
    # totalExtinguishedTCPDs:
    #   type: number
    #   decimals: 2
    maoriAuthorityDistributions_totalMACredits:
      decimals: 2
      type: number
    maoriAuthorityDistributions_totalMADistributions:
      decimals: 2
      type: number
    pieIncome_totalTaxCredits:
      decimals: 2
      type: number
    pieIncome_totalIncome:
      decimals: 2
      type: number
    partnershipIncome_totalTaxCredits:
      type: number
      decimals: 2
    partnershipIncome_totalIncome:
      type: number
      decimals: 2
    estateTrustIncome_totalTaxCredits:
      decimals: 2
      type: number
    estateTrustIncome_totalIncome:
      decimals: 2
      type: number
    ltcIncome_totalTaxCredits:
      decimals: 2
      type: number
    ltcIncome_totalIncome:
      decimals: 2
      type: number
    ltcNonAllowableDeductions:
      decimals: 2
      type: number
    ltcPriorYearNonAllowableDeductionsClaimed:
      decimals: 2
      type: number
    ltcAdjustedIncome:
      decimals: 2
      type: number
      value:  =IF(ltcIncome_totalIncome + ltcNonAllowableDeductions - ltcPriorYearNonAllowableDeductionsClaimed > 0,
               ltcIncome_totalIncome + ltcNonAllowableDeductions - ltcPriorYearNonAllowableDeductionsClaimed,
               NULL)
    otherCredits:
      decimals: 2
      type: number
      value: =totalPAYEDeducted + maoriAuthorityDistributions_totalMACredits + pieIncome_totalTaxCredits + partnershipIncome_totalTaxCredits + estateTrustIncome_totalTaxCredits +
              ltcIncome_totalTaxCredits +  rlwtCredit
    totalIncomeSubtotal:
      decimals: 2
      type: number
      value: =totalGrossIncome + maoriAuthorityDistributions_totalMADistributions + pieIncome_totalIncome + partnershipIncome_totalIncome +
             estateTrustIncome_totalIncome + ltcAdjustedIncome
    residentialRentalIncome_Indicator:
      type: select
      options:
        - label: Portfolio
          value: P
        - label: Individual
          value: I
        - label: Combined
          value: C
    residentialRentalIncome_totalIncome:
      type: number
      decimals: 2
    residentialRentalIncome_residentialRentalDeductions:
      type: number
      decimals: 2
    residentialRentalIncome_excessDeductionsBroughtForward:
      type: number
      decimals: 2
    residentialRentalIncome_deductionsClaimedThisYear:
      type: number
      decimals: 2
    residentialRentalIncome_netIncome:
      type: number
      decimals: 2
      # value: =residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear
      value: =IF(residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear = 0,
              NULL,residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear)
    residentialRentalIncome_excessDeductionsCarriedForward:
      type: number
      decimals: 2
      value: =residentialRentalIncome_excessDeductionsBroughtForward + residentialRentalIncome_residentialRentalDeductions - residentialRentalIncome_deductionsClaimedThisYear
    netRentalIncome:
      decimals: 2
      type: number
    selfEmployedIncome:
      decimals: 2
      type: number
    otherIncome:
      decimals: 2
      type: number
    rlwtCredit:
      decimals: 2
      type: number
    saleOfProperty:
      decimals: 2
      type: number
    totalIncome:
      decimals: 2
      type: number
      value:  =totalIncomeSubtotal + netRentalIncome + selfEmployedIncome + otherIncome + residentialRentalIncome_netIncome + saleOfProperty
    otherExpenses:
      decimals: 2
      type: number
    totalIncomeLossAfterExpenses:
      decimals: 2
      type: number
      value: =totalIncome - otherExpenses
    lossesBroughtForward:
      decimals: 2
      type: number
    lossesClaimedThisYear:
      decimals: 2
      type: number
    totalTaxableIncome:
      decimals: 2
      type: number
      value: =totalIncomeLossAfterExpenses - lossesClaimedThisYear
    workedInNZ:
      type: boolean
      defaultValue: false
    incomeEarned:
      type: number
      decimals: 2
    weeksWorked:
      type: number
      valid:
        - expression: '=weeksWorked  <= 52'
          errorMessage: Number of qualifying weeks can't be more than 52
      decimals: 0
    daysWorked:
      type: number
      decimals: 0
      valid:
        - expression: '=daysWorked <= 365'
          errorMessage: Number of qualifying days can't be more than 365
    arrivalDate:
      type: date
    departureDate:
      type: date
    # amountOfIETCClaimed:
    #   type: number
    #   decimals: 2
      # value:  =IF(AND(workedInNZ=TRUE,incomeEarned>=24000,incomeEarned<=48000),
      #         IF(incomeEarned > 44000,
      #         520 - ((48000 - incomeEarneds) * 0.013) * numberOfQualifyingMonths / 12,
      #         520 * numberOfQualifyingMonths / 12),
      #         NULL)
    imputationBroughtForward:
      type: number
      decimals: 2
    # taxOnTaxableIncome:
    #   decimals: 2
    #   type: number
    #   value:  =ROUND(IF(totalTaxableIncome > 70000,((totalTaxableIncome - 70000) * 0.33) + ((70000 - 48000) * 0.3) + ((48000 - 14000) * 0.175) + (14000 * 0.105),
    #           IF(totalTaxableIncome > 48000,((totalTaxableIncome - 48000) * 0.3) + ((48000 - 14000) * 0.175) + (14000 * 0.105),IF(totalTaxableIncome > 14000,
    #           ((totalTaxableIncome - 14000) * 0.175) + (14000 * 0.105),totalTaxableIncome * 0.105))),2)
    researchAndDevelopment_nonrefundableCredit:
      decimals: 2
      type: number
    taxAfterRandD:
      decimals: 2
      type: number
      value:  =IF(taxOnTaxableIncome >= researchAndDevelopment_nonrefundableCredit , taxOnTaxableIncome - researchAndDevelopment_nonrefundableCredit , 0)
    nonResidentWT:
      type: number
      decimals: 2
      value: = totalNRWTTax
    taxAfterNRWT:
      type: number
      decimals: 2
      value: = taxAfterRandD + nonResidentWT
    totalremainingTaxCredits:
      decimals: 2
      type: number
      value: = otherCredits + totalTaxCredits
    taxCreditsForTM:
      type: number
      decimals: 2
      defaultValue: "0"
    residualIncomeTax:
      decimals: 2
      type: number
      value: = taxAfterNRWT - totalremainingTaxCredits
    provisionalTaxPaid:
      decimals: 2
      type: number
    penaltiesDue:
      decimals: 2
      type:  number
    transfersFromOtherReturns:
      decimals: 2
      type: number
    terminalTax:
      decimals: 2
      type: number
      value:  =residualIncomeTax - provisionalTaxPaid + penaltiesDue - transfersFromOtherReturns
    earlyPaymentDiscountEligibility:
      type: boolean
      defaultValue: false
    earlyPaymentDiscount:
      type:  number
      decimals: 2
      defaultValue: "0"
    useOfMoneyInterest:
      type: number
      decimals: 2
      defaultValue: "0"
    uomiStartDate:
      type: date
      defaultValue: 31/03/2020
# Transfer section
    overpaymentProvisionalTax:
      decimals: 2
      type: number
    totalRefundDue:
      decimals: 2
      type: number
      value:  =terminalTax + overpaymentProvisionalTax
    transferRefundTo:
      type: list
      maxRows:  10
      fields:
        transferIrdNumber:
          type: number
          decimals: 0
        transferAccountType:
          options:
            - label: Income tax
              value: INC
            - label: Approved issuer levy
              value: AIL
            - label: Account information provider
              value: AIP
            - label: Common reporting standard
              value: CRS
            - label: Dividend withholding tax
              value: DWT
            - label: Fringe benefit tax
              value: FBT
            - label: Gaming machine duty
              value: GMD
            - label: GST on goods sold in satisfaction of debt
              value: GSD
            - label: Goods and services tax
              value: GST
            - label: Resident withholding tax on interest
              value: IPS
            - label: Resident withholding tax on interest (exempt recipient)
              value: IPE
            - label: Non-resident withholding tax
              value: NRT
            - label: Portfolio investment entity tax
              value: PIE
            - label: Payroll subsidy account
              value: PRS
            - label: 'Tax credits - donations, childcare, housekeeper'
              value: REB
            - label: Resident land withholding tax
              value: RLT
            - label: Resident withholding tax on specified dividends
              value: RWT
            - label: Student loan
              value: SLS
            - label: Working for families tax credits
              value: FAM
          type: select
        transferAmount:
          decimals: 2
          type: number
        associatedCustomer:
          defaultValue: false
          type: boolean
        transferFilingPeriod:
          defaultValue: 31/03/2020
          type: date
    transferTotal:
      decimals: 2
      type: number
      value:  =SUM(transferRefundTo:transferAmount)
    transferRemaining:
      decimals: 2
      type: number
      value:  =totalRefundDue + transferTotal
    provisionalTax_provisionalTaxOption:
      mandatory: true
      options:
        - label: Standard
          value: STD
        - label: Estimated
          value: EST
        - label: Ratio
          value: RATIO
      type: select
    provTaxEvenSplit:
      defaultValue: false
      type: boolean
    provisionalTax_provisionalTaxStartDate:
      type: date
    provisionalTaxCalc:
      type: number
      decimals: 2
      value:  =IF(residualIncomeTax > 2500 , IF(provisionalTax_provisionalTaxOption = "STD" , residualIncomeTax * 1.05 , 0 ) , 0 )
    provFromTaxManager:
      type: number
      decimals: 2
    # provisionalTax_provisionalTaxPayable:
    #   decimals: 2
    #   type: number
    #   value:  = IF(provisionalTax_provisionalTaxOption = "STD" , provisionalTaxCalc , provFromTaxManager )
    partYearReturnIndicator:
      type: boolean
      defaultValue: false
    partYearReason:
      type: select
      mandatory:  =partYearReturnIndicator = TRUE
      options:
        - label:  Arrived in New Zealand and now a tax resident
          value:  ARRIVE
        - label:  Declared bankrupt
          value:  BRUPT
        - label:  Balance date changed during the year
          value:  BDATE
        - label:  Returns is for a deceased person to the date of death
          value:  DECD
        - label:  Left New Zealand permanently (for more than 325 days)
          value:  DEPART
        - label:  Student loan borrower and left New Zealand for 184 days or more
          value:  STUDLN
    partYearStartDate:
      type: date
    partYearEndDate:
      type: date
    dateLeftNZ:
      type: date
    timePlannedToBeAway:
      type: text