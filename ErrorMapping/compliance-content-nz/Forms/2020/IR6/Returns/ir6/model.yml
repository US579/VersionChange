---
name: IR6 Trust return
model:
  fields:
    <<: !include
      source: ../../../Common/taxcalculatormodel.yml
      path: taxCalculatorFields
    
    <<: !include
      source: ../../../Common/provCalculatorModel.yml
      path: provCalculatorFields
 
    entityType:
      type: text
      defaultValue:  T
    taxYear:
      type: number
      decimals: 0
      defaultValue:  "2020"
    irdNumber:
      type: number
      decimals: 0
      mandatory: true
    nonResidentIndicator:
      defaultValue: false
      type: boolean
    isNilReturn:
      defaultValue: false
      type: boolean
    isFinalReturn:
      defaultValue: false
      type: boolean
    isAmended:
      defaultValue: false
      type: boolean
    amendReason:
      mandatory: = isAmended <> FALSE
      options:
        - label: Calculation error
          value: MATH
        - label: Incorrect amount entered
          value: KEY
        - label: Transposition error
          value: TRNSPO
        - label: Other
          value: OTHER
      type: select
    amendDetails:
      mandatory: = isAmended <> FALSE
      type: text
    submissionKey:
      maxLength: 32
      type: text
    firstReturnEstateTrustStartDate:
      type: date
    estateTrustType:
      type: select
      options:
        - label: Complying trust
          value: C
        - label: Foreign trust
          value: F
        - label: Non-complying trust
          value: N
    interestIncome_totalTaxPaid:
      decimals: 2
      type: number
    interestIncome_totalIncome:
      decimals: 2
      type: number
    dividendIncome_totalImputationCredits:
      decimals: 2
      type: number
    dividendIncome_totalRWTCredits:
      decimals: 2
      type: number
    dividendIncome_totalGrossDividends:
      decimals: 2
      type: number
    maoriAuthorityDistributions_totalMACredits:
      decimals: 2
      type: number
    maoriAuthorityDistributions_totalMADistributions:
      decimals: 2
      type: number
    partnershipEstateTrustIncome_totalTaxCredits:
      decimals: 2
      type: number
    partnershipEstateTrustIncome_totalIncome:
      decimals: 2
      type: number
    overseasIncome_totalTaxPaid:
      decimals: 2
      type: number
    overseasIncome_totalIncome:
      decimals: 2
      type: number
    pieIncome_totalTaxCredits:
      decimals: 2
      type: number
    pieIncome_totalIncome:
      decimals: 2
      type: number      
    ltcIncome_totalTaxCredits:
      decimals: 2
      type: number
    ltcIncome_totalIncome:
      decimals: 2
      type: number
    ltcNonAllowableDeductions:
      decimals: 2
      type: number
    ltcPriorYearNonAllowableDeductionsClaimed:
      decimals: 2
      type: number
    ltcAdjustedIncome:
      decimals: 2
      type: number
      value:  =IF(ltcIncome_totalIncome + ltcNonAllowableDeductions - ltcPriorYearNonAllowableDeductionsClaimed > 0,
               ltcIncome_totalIncome + ltcNonAllowableDeductions - ltcPriorYearNonAllowableDeductionsClaimed, 
               NULL)
    residentialRentalIncome_Indicator:
      type: select
      options:
        - label: Portfolio
          value: P
        - label: Individual
          value: I
        - label: Combined
          value: C
    residentialRentalIncome_totalIncome:
      type: number
      decimals: 2
    residentialRentalIncome_excessDeductionsBroughtForward:
      type: number
      decimals: 2
    residentialRentalIncome_residentialRentalDeductions:
      type: number
      decimals: 2
    residentialRentalIncome_deductionsClaimedThisYear:
      type: number
      decimals: 2
    residentialRentalIncome_excessDeductionsCarriedForward:
      type: number
      decimals: 2
      value: =IF(residentialRentalIncome_excessDeductionsBroughtForward + residentialRentalIncome_residentialRentalDeductions - residentialRentalIncome_deductionsClaimedThisYear > 0,
              residentialRentalIncome_excessDeductionsBroughtForward + residentialRentalIncome_residentialRentalDeductions - residentialRentalIncome_deductionsClaimedThisYear,NULL)
    residentialRentalIncome_netIncome:
      type: number
      decimals: 2
      # value: =IF(residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear > 0,
      #         residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear,NULL)
      value: =IF(residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear = 0,
               NULL,residentialRentalIncome_totalIncome - residentialRentalIncome_deductionsClaimedThisYear)
    businessOrRentalIncome:
      decimals: 2
      type: number
    otherIncome_totalTaxCredits:
      type: number
      decimals: 2
    otherIncome_totalIncome:
      type: number
      decimals: 2
    rlwtCredit:
      decimals: 2
      type: number
    saleOfProperty:
      decimals: 2
      type: number
    totalTaxCredits:
      decimals: 2
      type: number
      value: = interestIncome_totalTaxPaid + pieIncome_totalTaxCredits + dividendIncome_totalRWTCredits  + ltcIncome_totalTaxCredits + maoriAuthorityDistributions_totalMACredits + 
              partnershipEstateTrustIncome_totalTaxCredits + overseasIncome_totalTaxPaid + otherIncome_totalTaxCredits
    totalIncomeSubtotal:
      decimals: 2
      type: number
      value: = interestIncome_totalIncome + pieIncome_totalIncome + dividendIncome_totalGrossDividends + maoriAuthorityDistributions_totalMADistributions + 
              partnershipEstateTrustIncome_totalIncome + overseasIncome_totalIncome + businessOrRentalIncome + otherIncome_totalIncome + saleOfProperty + 
              residentialRentalIncome_netIncome + ltcAdjustedIncome
    beneficiaryIncome:
      type: number
      decimals: 2
    trusteeIncome:
      type: number
      decimals: 2
      value: = IF(totalIncomeSubtotal - beneficiaryIncome > 0.00,totalIncomeSubtotal - beneficiaryIncome,0.00)    
    totalExpensesClaimed:
      type: number
      decimals: 2
    lossesBroughtForward:
      decimals: 2
      type: number
    lossesClaimedThisYear:
      decimals: 2
      type: number
    totalDistributions:
      type: number
      decimals: 2
    totalTaxableDistributions:
      type: number
      decimals: 2
    disclosureRequiredCFCorFIF:
      type: boolean
    totalBeneficiaryTax:
      type: number
      decimals: 2
    totalTrusteeIncome:
      type: number
      decimals: 2
      value: = trusteeIncome - totalExpensesClaimed - lossesClaimedThisYear
    totalTaxableIncome:
      type: number
      decimals: 2
      value: =totalTrusteeIncome
    trusteeShareOfOverseasTaxPaid:
      decimals: 2
      type: number
      value:  =overseasIncome_totalTaxPaid - SUM(beneficiaryRepeat:beneficiary_overseasTaxPaid)
    taxAfterOverseasTax:
      type: number
      decimals: 2
      value: =IF(taxOnTaxableIncome >= trusteeShareOfOverseasTaxPaid , taxOnTaxableIncome - trusteeShareOfOverseasTaxPaid , 0)
    trusteeShareOfDivImpCredits:
      decimals: 2
      type: number
      value: =dividendIncome_totalImputationCredits - SUM(beneficiaryRepeat:beneficiary_dividendImputationCredit)
    taxAfterImpCredits:
      type: number
      decimals: 2
      value:  =IF(taxAfterOverseasTax >= trusteeShareOfDivImpCredits , taxAfterOverseasTax - trusteeShareOfDivImpCredits ,0)
  # If Div imp credits greater than tax available, then they should be converted and carried forward, done in workpaper?
    researchAndDevelopment_nonrefundableCredit:
      type: number
      decimals: 2
    taxAfterNonRefRD:
      type: number
      decimals: 2
      value: =IF(taxAfterImpCredits >= researchAndDevelopment_nonrefundableCredit , taxAfterImpCredits - researchAndDevelopment_nonrefundableCredit ,0)
    researchAndDevelopment_refundableCredit:
      type: number
      decimals: 2
    taxAfterRefRD:
      type: number
      decimals: 2
      value: =IF(taxAfterNonRefRD >= researchAndDevelopment_refundableCredit , taxAfterNonRefRD - researchAndDevelopment_refundableCredit ,0)
    totalremainingTaxCredits:
      decimals: 2
      type: number
      value:  =totalTaxCredits - overseasIncome_totalTaxPaid + rlwtCredit - SUM(beneficiaryRepeat:beneficiary_otherPaidTaxCredits)
    taxOnTrusteeIncomeLessCredits:
      type: number
      decimals: 2
      value: =taxAfterRefRD - totalremainingTaxCredits
    beneficiaryTaxPayable:
      type: number
      decimals: 2
      value: =totalBeneficiaryTax
    trusteeTaxPayable:
      type: number
      decimals: 2
      value: =taxOnTrusteeIncomeLessCredits
    taxCreditsForTM:
      type: number
      decimals: 2
      defaultValue: "0"
    residualIncomeTax:
      decimals: 2
      type: number
      value:  =beneficiaryTaxPayable + trusteeTaxPayable
    useOfMoneyInterest:
      type: number
      decimals: 2
      defaultValue: "0"
    uomiStartDate:
      type: date
      defaultValue: 31/03/2020
    provisionalTaxPaid:
      decimals: 2
      type: number
    penaltiesDue:
      decimals: 2
      type:  number
    transfersFromOtherReturns:
      decimals: 2
      type: number
    terminalTax:
      decimals: 2
      type: number
      value:  =residualIncomeTax - provisionalTaxPaid + penaltiesDue - transfersFromOtherReturns
# Transfer section
    overpaymentProvisionalTax:
      type: number
      decimals: 2
    totalRefundDue:
      type: number
      decimals: 2
      value:  =terminalTax + overpaymentProvisionalTax
    transferRefundTo:
      type: list
      maxRows:  10
      fields:
        transferIrdNumber:
          type: number
          decimals: 0     
        transferAccountType:
          options:
            - label: Income tax
              value: INC
            - label: Approved issuer levy
              value: AIL
            - label: Account information provider
              value: AIP
            - label: Common reporting standard
              value: CRS
            - label: Dividend withholding tax
              value: DWT
            - label: Fringe benefit tax
              value: FBT
            - label: Gaming machine duty
              value: GMD
            - label: GST on goods sold in satisfaction of debt
              value: GSD
            - label: Goods and services tax
              value: GST
            - label: Resident withholding tax on interest
              value: IPS
            - label: Resident withholding tax on interest (exempt recipient)
              value: IPE
            - label: Non-resident withholding tax
              value: NRT
            - label: Portfolio investment entity tax
              value: PIE
            - label: Payroll subsidy account
              value: PRS
            - label: 'Tax credits - donations, childcare, housekeeper'
              value: REB
            - label: Resident land withholding tax
              value: RLT
            - label: Resident withholding tax on specified dividends
              value: RWT
            - label: Student loan
              value: SLS
            - label: Working for families tax credits
              value: FAM
          type: select
        transferAmount:
          decimals: 2
          type: number
        associatedCustomer:
          defaultValue: false
          type: boolean
        transferFilingPeriod:
          defaultValue: 31/03/2020
          type: date
    transferTotal:
      decimals: 2
      type: number
      value:  =SUM(transferRefundTo:transferAmount)    
    transferRemaining:
      decimals: 2
      type: number
      value:  =terminalTax + transferTotal
    provisionalTax_provisionalTaxOption:
      mandatory: true
      options:
        - label: Standard
          value: STD
        - label: Estimated
          value: EST
        - label: Ratio
          value: RATIO
      type: select
    provTaxEvenSplit:
      defaultValue: false
      type: boolean
    provisionalTax_provisionalTaxStartDate:
      type: date
    provisionalTaxCalc:
      type: number
      decimals: 2
      value:  = IF(residualIncomeTax > 2500 , IF(provisionalTax_provisionalTaxOption = "STD" , residualIncomeTax * 1.05 , 0 ) , 0 )
    provFromTaxManager:
      type: number
      decimals: 2
    # provisionalTax_provisionalTaxPayable:
    #   decimals: 2
    #   type: number
    #   value:  = IF(provisionalTax_provisionalTaxOption = "STD" , provisionalTaxCalc , provFromTaxManager )
# Beneficiary distribution
    beneficiaryRepeat:
      type: list
      fields:
        beneficiary_beneficiaryName:
          type: text
        beneficiary_beneficiaryIrdNumber:
          type: number
          decimals: 0
        beneficiary_beneficiaryDOB:
          type: date
        beneficiary_beneficiaryAddress:
          type: text
        beneficiary_beneficiaryIsNonResident:
          type: boolean
          defaultValue: FALSE
        beneficiary_shareOfInterestIncome:
          type: number
          decimals: 2
        beneficiary_shareOfDividendsIncome:
          type: number
          decimals: 2
        beneficiary_shareOfMADistributionsIncome:
          type: number
          decimals: 2
        beneficiary_shareOfOverseasIncome:
          type: number
          decimals: 2
        beneficiary_shareOfOtherIncome:
          type: number
          decimals: 2
        beneficiary_taxableIncome:
          type: number
          decimals: 2
          value:  =beneficiaryRepeat#CURR#beneficiary_shareOfInterestIncome + beneficiaryRepeat#CURR#beneficiary_shareOfDividendsIncome + 
                  beneficiaryRepeat#CURR#beneficiary_shareOfMADistributionsIncome + beneficiaryRepeat#CURR#beneficiary_shareOfOverseasIncome + 
                  beneficiaryRepeat#CURR#beneficiary_shareOfOtherIncome 
        beneficiary_taxPaidByTrust:
          type: boolean
        beneficiary_distributionByNonComplyingtrust:
          type: number
          decimals: 2
        beneficiary_taxOnTaxableIncome:
          type: number
          decimals: 2
        beneficiary_overseasTaxPaid:
          type: number
          decimals: 2
        beneficiary_taxLessOverseasTaxPaid:
          type: number
          decimals: 2
          value:  =beneficiaryRepeat#CURR#beneficiary_taxOnTaxableIncome - beneficiaryRepeat#CURR#beneficiary_overseasTaxPaid
        beneficiary_dividendImputationCredit:
          type: number
          decimals: 2
        beneficiary_taxLessDividendImputationCredit:
          type: number
          decimals: 2
          value: =beneficiaryRepeat#CURR#beneficiary_taxLessOverseasTaxPaid - beneficiaryRepeat#CURR#beneficiary_dividendImputationCredit
        beneficiary_otherPaidTaxCredits:
          type: number
          decimals: 2
        beneficiary_taxLessOtherPaidTaxCredits:
          type: number
          decimals: 2
          value: =beneficiaryRepeat#CURR#beneficiary_taxLessDividendImputationCredit - beneficiaryRepeat#CURR#beneficiary_otherPaidTaxCredits
        beneficiary_taxOnDistributionByNonComplyingTrust:
          type: number
          decimals: 2
        beneficiary_beneficiaryTaxPayable:
          type: number
          decimals: 2
          value: =beneficiaryRepeat#CURR#beneficiary_taxLessOtherPaidTaxCredits + beneficiaryRepeat#CURR#beneficiary_taxOnDistributionByNonComplyingTrust 
               