---
model:
  fields:
    TaxYear:
      type: select
      options:
        - value: '2019'
          label: '2019'
        - value: '2020'
          label: '2020'
        - value: '2021' 
          label: '2021'

    EntityType:
      type: select
      options:
        - value: 'I'
          label: 'Individual'
        - value: 'C'
          label: 'Company'
        - value: 'T'
          label: 'Trust'

## Tax rates ... we only have 2019 at this stage. 
## They have not changed for 2020, but we would need some more complex logic if/when they do change

## Company tax rate 2019
    TaxRate_C_2019:
      type: number
      value: = 0.28

## Trust tax rate 2019
    TaxRate_T_2019:
      type: number
      value: = 0.33

## Individuals tax rates and threshholds 2019
    TaxRate_I_2019_1:
      type: number
      value: = 0.105
    TaxThreshhold_I_2019_1:
      type: number  
      value: = 0
    TaxRate_I_2019_2:
      type: number
      value: = 0.175
    TaxThreshhold_I_2019_2:
      type: number
      value: = 14000
    TaxRate_I_2019_3:
      type: number
      value: = 0.30
    TaxThreshhold_I_2019_3:
      type: number
      value: = 48000
    TaxRate_I_2019_4:
      type: number
      value: = 0.33
    TaxThreshhold_I_2019_4:
      type: number
      value: = 70000
    
## Taxable income to be entered by user    
    TaxableIncome:
      type: number
      
## We can simplify the calculation, make it easier to maintain in future years by bring them 
#  all into one set of genric rates and threshholds

## because companies and trusts only have one rate, only rate 4 will be non-zero

    TaxRate_1:
      type: number
      value:
        = IF(EntityType="C",0,
            IF(EntityType="T",0,
              IF(EntityType="I",TaxRate_I_2019_1, 0) ) )
    TaxThreshhold_1:
      type: number
      value: 
        = IF(EntityType="C",0,
            IF(EntityType="T",0,
              IF(EntityType="I",TaxThreshhold_I_2019_1,0) ) )
    TaxRate_2:
      type: number
      value:
        = IF(EntityType="C",0,
            IF(EntityType="T",0,
              IF(EntityType="I",TaxRate_I_2019_2, 0) ) )
    TaxThreshhold_2:
      type: number
      value: 
        = IF(EntityType="C",0,
            IF(EntityType="T",0,
              IF(EntityType="I",TaxThreshhold_I_2019_2,0) ) )
    TaxRate_3:
      type: number
      value:
        = IF(EntityType="C",0,
            IF(EntityType="T",0,
              IF(EntityType="I",TaxRate_I_2019_3, 0) ) )
    TaxThreshhold_3:
      type: number
      value: 
        = IF(EntityType="C",0,
            IF(EntityType="T",0,
              IF(EntityType="I",TaxThreshhold_I_2019_2,0) ) )
    TaxRate_4:
      type: number
      value:
        = IF(EntityType="C",TaxRate_C_2019,
            IF(EntityType="T",TaxRate_T_2019,
              IF(EntityType="I",TaxRate_I_2019_4, 0) ) )
    TaxThreshhold_4:
      type: number
      value: 
        = IF(EntityType="C",0,
            IF(EntityType="T",0,
              IF(EntityType="I",TaxThreshhold_I_2019_4,0) ) )

## Income tax is always calculated on whole dollars and the amount is rounded down
    TaxableIncomeInteger:
      type: number
      value: = ROUNDDOWN(TaxableIncome,0)

 ## This is the tax calculation. Works for all entity types
    TaxAmount:
      type: number
      value: 
        = IF(TaxableIncomeInteger > TaxThreshhold_4,
              ROUND((TaxableIncomeInteger - TaxThreshhold_4) * TaxRate_4,2)
            + ROUND((TaxThreshhold_4 - TaxThreshhold_3) * TaxRate_3,2)
            + ROUND((TaxThreshhold_3 - TaxThreshhold_2) * TaxRate_2,2)
            + ROUND((TaxThreshhold_2 - TaxThreshhold_1) * TaxRate_1,2),
            IF(TaxableIncomeInteger > TaxThreshhold_3,
                ROUND((TaxableIncomeInteger - TaxThreshhold_3) * TaxRate_4,2)
              + ROUND((TaxThreshhold_3 - TaxThreshhold_2) * TaxRate_2,2)
              + ROUND((TaxThreshhold_2 - TaxThreshhold_1) * TaxRate_1,2),
              IF(TaxableIncomeInteger > TaxThreshhold_2,
                  ROUND((TaxableIncomeInteger - TaxThreshhold_2) * TaxRate_2,2)
                + ROUND((TaxThreshhold_2 - TaxThreshhold_1) * TaxRate_1,2),
                ROUND(TaxableIncomeInteger * TaxRate_1,2)
                )
              )
            )
       
## average tax rate -- just for fun.    
    AverageTaxRate:
      type: number  
      value: = IF(TaxableIncomeInteger <= 0,
                  0,
                  ROUND(TaxAmount / TaxableIncomeInteger * 100,2)
                  )

name: Tax Calculator

